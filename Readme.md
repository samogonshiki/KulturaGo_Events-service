# KulturaGo_Events-service


## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
events-service/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ events-service/
‚îÇ       ‚îî‚îÄ‚îÄ main.go
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ postgres/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis/
‚îÇ   ‚îú‚îÄ‚îÄ usecase/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exporter.go
‚îÇ   ‚îú‚îÄ‚îÄ broker/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ kafka/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ producer.go
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ health.go
‚îÇ   ‚îú‚îÄ‚îÄ transport/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ http/
‚îÇ   ‚îú‚îÄ‚îÄ scheduler/
‚îÇ   ‚îú‚îÄ‚îÄ logger/
‚îÇ   ‚îî‚îÄ‚îÄ metrics/
‚îú‚îÄ‚îÄ pkg/
‚îú‚îÄ‚îÄ migrations/
‚îú‚îÄ‚îÄ deploy/
‚îÇ   ‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îî‚îÄ‚îÄ k8s/
‚îÇ       ‚îú‚îÄ‚îÄ deployment.yaml 
‚îÇ       ‚îî‚îÄ‚îÄ service.yaml
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ Makefile
‚îî‚îÄ‚îÄ go.mod
```

---

## üåê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

```mermaid
flowchart LR
    PG[PostgreSQL]
    Exp[Exporter]
    Kafka[(Kafka topic: events.public)]
    Redis[(Redis)]

    PG -- batched-fetch --> Exp
    Exp -- produce --> Kafka
    Kafka -- store cursor --> Redis
    Redis -- last_event_ts --> Exp
```

## HTTP API


| Method | Path                                 | Description                                  | Request Body (JSON)          | Response Code  |
|:------:|:-------------------------------------|:---------------------------------------------|:-----------------------------|:---------------|
| GET    | `/api/v1/events?limit={limit}&offset={offset}` | –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ)       | ‚Äî                             | `200 OK`       |
| GET    | `/api/v1/events/{slug}`              | –î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è –ø–æ –µ–≥–æ `slug`                | ‚Äî                             | `200 OK`       |
| POST   | `/api/v1/events`                     | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è                | `CreateEventInput` (—Å–º. –≤—ã—à–µ) | `201 Created`  |

**Query Parameters for GET `/api/v1/events`**
- `limit`: `int` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚Äî —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –≤–µ—Ä–Ω—É—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50).
- `offset`: `int` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚Äî —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**

```
{
  "category": {
    "name": "–≤—ã—Å—Ç–∞–≤–∫–∞"
  },
  "title": "–í—ã—Å—Ç–∞–≤–∫–∞ –∏—Å–∫—É—Å—Å—Ç–≤ –°–µ–≤–µ—Ä–∞",
  "description": "–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –≤—Å–µ—Ö!",
  "place": {
    "address": "—É–ª. –õ–µ–Ω–∏–Ω–∞, 1, –ú–æ—Å–∫–≤–∞",
    "latitude": 55.751244,
    "longitude": 37.618423
  },
  "starts_at": "2025-11-01T10:00:00Z",
  "ends_at":   "2025-11-01T13:00:00Z",
  "photos": [
    {
      "url": "https://example.com/photos/vsosh-main.jpg",
      "alt_text": "–õ–æ–≥–æ—Ç–∏–ø –≤—ã—Å—Ç–∞–≤–∫–∏",
      "is_main": true
    },
    {
      "url": "https://example.com/photos/vsosh-participants.jpg",
      "alt_text": "–≤—Å–µ",
      "is_main": false
    }
  ],
  "legal_info": [],
  "people": [
    {
      "name": "–§–µ—Ç—é–∫–æ–≤ –ù–∏–∫–∏—Ç–∞",
      "tag": {
        "name": "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä"
      }
    }
  ]
}
```


## –¢–∞–±–ª–∏—Ü–∞ `event_categories`

| –ü–æ–ª–µ  | –¢–∏–ø             | NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                         |
|-------|-----------------|------|--------------|----------------------------------|
| id    | `smallserial`   | ‚ùå   | ‚Äî            | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á                   |
| slug  | `varchar(32)`   | ‚ùå   | ‚Äî            | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π slug |
| name  | `varchar(64)`   | ‚ùå   | ‚Äî            | –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏               |

**–ò–Ω–¥–µ–∫—Å—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**
- `event_categories_pkey` (PK –ø–æ `id`)
- `event_categories_slug_key` (UNIQUE –ø–æ `slug`)

---

## –¢–∞–±–ª–∏—Ü–∞ `tags`

| –ü–æ–ª–µ  | –¢–∏–ø             | NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                         |
|-------|-----------------|------|--------------|----------------------------------|
| id    | `smallserial`   | ‚ùå   | ‚Äî            | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á                   |
| slug  | `varchar(32)`   | ‚ùå   | ‚Äî            | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π slug |
| name  | `varchar(64)`   | ‚ùå   | ‚Äî            | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞                    |

**–ò–Ω–¥–µ–∫—Å—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**
- `tags_pkey` (PK –ø–æ `id`)
- `tags_slug_key` (UNIQUE –ø–æ `slug`)

---

## –¢–∞–±–ª–∏—Ü–∞ `places`

| –ü–æ–ª–µ         | –¢–∏–ø                | NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ               |
|--------------|--------------------|------|--------------|------------------------|
| id           | `bigserial`        | ‚ùå   | ‚Äî            | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á         |
| title        | `varchar(128)`     | ‚ùå   | ‚Äî            | –ù–∞–∑–≤–∞–Ω–∏–µ/–∑–∞–≥–æ–ª–æ–≤–æ–∫     |
| country      | `varchar(64)`      | ‚úÖ   | ‚Äî            | –°—Ç—Ä–∞–Ω–∞                 |
| region       | `varchar(64)`      | ‚úÖ   | ‚Äî            | –†–µ–≥–∏–æ–Ω/–æ–±–ª–∞—Å—Ç—å         |
| city         | `varchar(128)`     | ‚ùå   | ‚Äî            | –ì–æ—Ä–æ–¥                  |
| street       | `varchar(256)`     | ‚úÖ   | ‚Äî            | –£–ª–∏—Ü–∞                  |
| house_num    | `varchar(16)`      | ‚úÖ   | ‚Äî            | –ù–æ–º–µ—Ä –¥–æ–º–∞             |
| postal_code  | `varchar(16)`      | ‚úÖ   | ‚Äî            | –ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å        |
| longitude    | `numeric(9,6)`     | ‚úÖ   | ‚Äî            | –î–æ–ª–≥–æ—Ç–∞                |
| latitude     | `numeric(9,6)`     | ‚úÖ   | ‚Äî            | –®–∏—Ä–æ—Ç–∞                 |
| created_at   | `timestamptz`      | ‚ùå   | `now()`      | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏   |

**–ò–Ω–¥–µ–∫—Å—ã**
- `idx_places_city` (`city`)
- `idx_places_country` (`country`)

---

## –¢–∞–±–ª–∏—Ü–∞ `events`

| –ü–æ–ª–µ         | –¢–∏–ø                | NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é        | –û–ø–∏—Å–∞–Ω–∏–µ                                         |
|--------------|--------------------|------|---------------------|--------------------------------------------------|
| id           | `bigserial`        | ‚ùå   | ‚Äî                   | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á                                   |
| slug         | `varchar(128)`     | ‚ùå   | ‚Äî                   | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–±—ã—Ç–∏—è|
| category_id  | `smallint`         | ‚ùå   | ‚Äî                   | FK ‚Üí `event_categories(id)`                      |
| title        | `varchar(64)`      | ‚ùå   | ‚Äî                   | –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è                                 |
| description  | `varchar(4096)`    | ‚ùå   | ‚Äî                   | –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è                                 |
| place_id     | `bigint`           | ‚ùå   | ‚Äî                   | FK ‚Üí `places(id)` (–ª–æ–∫–∞—Ü–∏—è)                      |
| starts_at    | `timestamptz`      | ‚ùå   | ‚Äî                   | –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞                                     |
| ends_at      | `timestamptz`      | ‚ùå   | ‚Äî                   | –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è                                  |
| is_active    | `boolean`          | ‚ùå   | `TRUE`              | –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏                                  |
| created_at   | `timestamptz`      | ‚ùå   | `now()`             | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏                            |
| updated_at   | `timestamptz`      | ‚ùå   | `now()`             | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ç—Ä–∏–≥–≥–µ—Ä)            |

**–ò–Ω–¥–µ–∫—Å—ã –∏ —Ç—Ä–∏–≥–≥–µ—Ä**
- `events_pkey` (PK –ø–æ `id`)
- `events_slug_key` (UNIQUE –ø–æ `slug`)
- `idx_events_active` (`is_active`)
- `idx_events_category` (`category_id`)
- `idx_events_starts_at` (`starts_at`)
- `idx_events_ends_at` (`ends_at`)
- `idx_events_place` (`place_id`)
- –¢—Ä–∏–≥–≥–µ—Ä `events_set_updated_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç `updated_at` –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º `UPDATE events`.

---

## –¢–∞–±–ª–∏—Ü–∞ `legal_information`

| –ü–æ–ª–µ      | –¢–∏–ø             | NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                             |
|-----------|-----------------|------|--------------|--------------------------------------|
| id        | `bigserial`     | ‚ùå   | ‚Äî            | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á                       |
| event_id  | `bigint`        | ‚ùå   | ‚Äî            | FK ‚Üí `events(id)`                    |
| info_key  | `varchar(64)`   | ‚ùå   | ‚Äî            | –ö–ª—é—á –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–æ–ª—è            |
| info_text | `text`          | ‚ùå   | ‚Äî            | –¢–µ–∫—Å—Ç –ø—Ä–∞–≤–æ–≤–æ–π/–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ |

**–ò–Ω–¥–µ–∫—Å—ã**
- `idx_legal_info_event` (`event_id`)

---

## –¢–∞–±–ª–∏—Ü–∞ `event_photos`

| –ü–æ–ª–µ       | –¢–∏–ø             | NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                  |
|------------|-----------------|------|--------------|---------------------------|
| id         | `bigserial`     | ‚ùå   | ‚Äî            | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á            |
| event_id   | `bigint`        | ‚ùå   | ‚Äî            | FK ‚Üí `events(id)`         |
| url        | `text`          | ‚ùå   | ‚Äî            | –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é      |
| alt_text   | `varchar(256)`  | ‚úÖ   | ‚Äî            | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç      |
| is_main    | `boolean`       | ‚ùå   | `FALSE`      | –§–ª–∞–≥ ‚Äú–≥–ª–∞–≤–Ω–æ–π‚Äù —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ |
| created_at | `timestamptz`   | ‚ùå   | `now()`      | –í—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è          |

**–ò–Ω–¥–µ–∫—Å—ã**
- `idx_photos_event` (`event_id`)

---

## –¢–∞–±–ª–∏—Ü–∞ `persons`

| –ü–æ–ª–µ        | –¢–∏–ø              | NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                      |
|-------------|------------------|------|--------------|-------------------------------|
| id          | `bigserial`      | ‚ùå   | ‚Äî            | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á                |
| slug        | `varchar(128)`   | ‚ùå   | ‚Äî            | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π slug |
| name        | `varchar(256)`   | ‚ùå   | ‚Äî            | –ò–º—è/–§–ò–û —á–µ–ª–æ–≤–µ–∫–∞              |
| description | `text`           | ‚úÖ   | ‚Äî            | –û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω—ã              |
| photo       | `text`           | ‚ùå   | ‚Äî            | –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ                |
| created_at  | `timestamptz`    | ‚ùå   | `now()`      | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏         |

**–ò–Ω–¥–µ–∫—Å—ã**
- `idx_people_slug` (`slug`)

---

## –¢–∞–±–ª–∏—Ü–∞ `event_people`

| –ü–æ–ª–µ       | –¢–∏–ø           | NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
|------------|---------------|------|--------------|------------------------------------------|
| id         | `bigserial`   | ‚ùå   | ‚Äî            | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á                           |
| event_id   | `bigint`      | ‚ùå   | ‚Äî            | FK ‚Üí `events(id)`                        |
| person_id  | `bigint`      | ‚ùå   | ‚Äî            | FK ‚Üí `persons(id)`                       |
| tag_id     | `smallint`    | ‚ùå   | ‚Äî            | FK ‚Üí `tags(id)`                          |
| sort_order | `smallint`    | ‚ùå   | `0`          | –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–¥–ª—è –≤—ã–≤–æ–¥–∞ –ª—é–¥–µ–π)    |

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**
- `UNIQUE (event_id, person_id, tag_id)`

---

## –¢–∞–±–ª–∏—Ü–∞ `export_cursors`

| –ü–æ–ª–µ           | –¢–∏–ø            | NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                                |
|----------------|----------------|------|--------------|-----------------------------------------|
| consumer       | `text`         | ‚ùå   | ‚Äî            | –ò–º—è –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è                        |
| last_event_ts  | `timestamptz`  | ‚ùå   | ‚Äî            | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è |

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è makefile

- –ª–æ–∫–∞–ª—å–Ω–æ (development)
```shell
make migrate-up
```
- –æ—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞ –æ–¥–∏–Ω —à–∞–≥
```shell
make migrate-down
```


- –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ stage/prod
```shell
GOOSE_ENV=production DATABASE_URL="postgres://user:pass@postgres:5432/prod?sslmode=disable" \
make migrate-up
```

**by Finnik**